{% extends 'base_dashboard.html' %}
{% block title %}Lista Usuários{% endblock %}
{% load static %}
{% block content_dash %}
<div class="surface-card table-card">
	<div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center gap-3 mb-4">
		<div class="d-flex align-items-center gap-2">
			<button class="btn btn-secondary" onclick="window.location.href='{% url 'adicionar_usuario' %}'">
				<i class="fas fa-user mx-2"></i> Adicionar Usuário
			</button>
		</div>
		<h2 class="table-title mb-0 me-lg-auto">Usuários</h2>
        <form id="userSearchForm" class="ms-lg-auto w-100 w-lg-auto" method="get" autocomplete="off">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input
                    type="search"
                    class="form-control"
                    id="userSearchInput"
                    name="q"
                    value="{{ query }}"
                    placeholder="Buscar por nome, e-mail ou usuário"
                >
            </div>
        </form>
	</div>
	<div class="table-responsive">
		<table class="table theme-table align-middle">
			<thead>
				<tr>
					<th scope="col">#</th>
                    <th scope="col">Foto</th>
					<th scope="col">Nome</th>
					<th scope="col">E-mail</th>
					<th scope="col">Data Criação</th>
					<th scope="col">Perfil</th>
					<th scope="col">Status</th>
					<th scope="col">Ação</th>
				</tr>
			</thead>
			<tbody>
			{% for usuario in lista_usuarios %}
				<tr>
                    <td scope="row">{{ usuario.id }}</td>
                    <td>
                        <img src="{{ usuario.perfil.foto_url }}" class="img-thumbnail rounded user-avatar-thumb" alt="Foto de perfil">
                    </td>
					<td>{{ usuario.first_name }} {{ usuario.last_name }}</td>
					<td>{{ usuario.email }}</td>
					<td>{{ usuario.date_joined|date:'d/m/Y'}}</td>
					<td>{{ usuario.groups.all.0.name }}</td>
					<td>
						{% if usuario.is_active %}
						<span class="badge bg-success rounded-pill">Ativado</span> 
						{% else %}
						<span class="badge bg-danger rounded-pill">Desativado</span>  
						{% endif %}
					</td>
					<td class="text-nowrap">
						<a class="link-warning" href=""><i class="fas fa-eye mx-2"></i></a>
						<a class="link-secondary" href="{% url 'atualizar_usuario' usuario.username %}"><i class="far fa-file mx-2"></i></a>
						<a class="link-danger" href=""><i class="fas fa-trash mx-2"></i></a>
					</td>
				</tr>
			{% empty %}
				<tr>
					<td colspan="8" class="text-center text-muted py-4">Nenhum usuário cadastrado.</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchForm = document.getElementById('userSearchForm');
    const searchInput = document.getElementById('userSearchInput');
    if (!searchForm || !searchInput) {
        return;
    }
    let debounceTimer = null;
    const submitForm = () => {
        if (typeof searchForm.requestSubmit === 'function') {
            searchForm.requestSubmit();
        } else {
            searchForm.submit();
        }
    };
    searchInput.addEventListener('input', function () {
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        debounceTimer = setTimeout(submitForm, 400);
    });
});
</script>
{% endblock %}
